generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Usuários da aplicação
model User {
  id           String     @id @default(cuid())
  name         String
  email        String     @unique
  passwordHash String
  roles        Role[]     @default([VIEWER])
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  status       UserStatus @default(PENDING)

  @@index([email])
  @@map("users")
}

model WorkfrontProject {
  id                String             @id @default(cuid())
  url               String             @unique
  title             String?
  description       String?
  projectId         String?
  dsid              String?
  status            LinkStatus         @default(ACTIVE)
  accessedAt        DateTime           @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  accessSessions    AccessSession[]
  briefingDownloads BriefingDownload[]

  @@map("workfront_projects")
}

model AccessSession {
  id         String           @id @default(cuid())
  projectId  String
  userAgent  String?
  ipAddress  String?
  accessedAt DateTime         @default(now())
  project    WorkfrontProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("access_sessions")
}

model BriefingDownload {
  id          String           @id @default(cuid())
  projectId   String
  projectName String
  dsid        String?
  totalFiles  Int              @default(0)
  totalSize   BigInt           @default(0)
  status      DownloadStatus   @default(PROCESSING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  project     WorkfrontProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pdfFiles    PdfFile[]

  @@map("briefing_downloads")
}

model PdfFile {
  id               String               @id @default(cuid())
  downloadId       String
  originalFileName String
  originalUrl      String?
  fileSize         BigInt               @default(0)
  pageCount        Int                  @default(0)
  hasContent       Boolean              @default(false)
  hasComments      Boolean              @default(false)
  processedAt      DateTime             @default(now())
  createdAt        DateTime             @default(now())
  extractedContent PdfExtractedContent?
  download         BriefingDownload     @relation(fields: [downloadId], references: [id], onDelete: Cascade)
  structuredData   PdfStructuredData?

  @@map("pdf_files")
}

model PdfExtractedContent {
  id        String   @id @default(cuid())
  pdfFileId String   @unique
  fullText  String?
  comments  Json?
  links     String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  pdfFile   PdfFile  @relation(fields: [pdfFileId], references: [id], onDelete: Cascade)

  @@map("pdf_extracted_content")
}

model PdfStructuredData {
  id              String   @id @default(cuid())
  pdfFileId       String   @unique
  liveDate        String?
  vf              String?
  copy            String?
  description     String?
  cta             String?
  backgroundColor String?
  copyColor       String?
  postcopy        String?
  urn             String?
  allocadia       String?
  extractedAt     DateTime @default(now())
  updatedAt       DateTime @updatedAt
  headline        String?
  formats         Json?
  pdfFile         PdfFile  @relation(fields: [pdfFileId], references: [id], onDelete: Cascade)

  @@map("pdf_structured_data")
}

/// Registro de master assets armazenados no Bunny CDN
model MasterAsset {
  id              String             @id @default(cuid())
  title           String
  brand           String?
  description     String?
  fileName        String
  fileType        MasterFileType
  editableType    MasterEditableType
  fileSize        BigInt
  frameCount      Int?
  width           Int?
  height          Int?
  aspectRatio     String?
  checksum        String?            @unique
  bunnyPath       String
  bunnyCdnUrl     String
  previewImageUrl String?
  tags            String[]
  version         Int                @default(1)
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  archivedAt      DateTime?

  @@index([brand])
  @@index([fileType])
  @@index([editableType])
  @@index([isActive])
  @@index([createdAt])
  @@map("master_assets")
}

/// Registro de uploads temporários no Bunny CDN (para limpeza automática)
model TempUpload {
  id          String    @id
  storagePath String    @unique
  cdnUrl      String
  fileName    String
  fileSize    BigInt?
  userId      String?
  projectUrl  String?
  isUsed      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  deletedAt   DateTime?

  @@index([expiresAt])
  @@index([isUsed])
  @@index([createdAt])
  @@map("temp_uploads")
}

/// Cards do quadro Kanban baseado no CSV de jobs
model KanbanCard {
  id                String          @id @default(cuid())
  bi                Boolean         @default(true)
  anotacoes         String?
  start             DateTime?
  realDeliv         DateTime?
  prevDeliv         DateTime?
  dsid              String?
  atividade         String
  status            KanbanStatus    @default(BACKLOG)
  studio            String?
  vf                VFType?         @default(NO_VF)
  tipoAsset         AssetType       @default(OTHER)
  numeroAssets      Int             @default(1)
  cliente           String?
  brand             String?
  week              String?
  quarter           String?
  frente            WorkfrontFrente @default(SOCIAL)
  fy                FiscalYear?
  entregaR1VML      DateTime?
  feedbackR1Dell    DateTime?
  entregaR2VML      DateTime?
  feedbackR2Dell    DateTime?
  entregaR3VML      DateTime?
  feedbackR3Dell    DateTime?
  entregaR4VML      DateTime?
  feedbackR4Dell    DateTime?
  diasStartR1VML    Int?
  diasR1VMLR1Dell   Int?
  diasR1DellR2VML   Int?
  diasR2VMLR2Dell   Int?
  diasR2DellR3VML   Int?
  diasR3VMLR3Dell   Int?
  diasR3DellR4VML   Int?
  diasR4VMLR4Dell   Int?
  diasNaVMLPercent  Float?
  diasNaDellPercent Float?
  position          Int             @default(0)
  columnId          String?
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  round             Int?

  @@index([status])
  @@index([week])
  @@index([quarter])
  @@index([fy])
  @@index([cliente])
  @@index([brand])
  @@index([frente])
  @@index([columnId])
  @@index([createdAt])
  @@map("kanban_cards")
}

/// Perfis / papéis de acesso do sistema
enum Role {
  ADMIN
  EDITOR
  VIEWER
}

/// Status de aprovação de usuários
enum UserStatus {
  PENDING
  ACTIVE
  REJECTED
}

enum LinkStatus {
  ACTIVE
  ARCHIVED
  EXPIRED
  ERROR
}

enum DownloadStatus {
  PROCESSING
  COMPLETED
  FAILED
  PARTIAL
}

/// Tipo de arquivo master (extensão/base)
enum MasterFileType {
  PSD
  AI
  AE
  HTML
  PDF
  JPG
  PNG
  MP4
  OTHER
}

/// Tipo de editável (como será reutilizado)
enum MasterEditableType {
  STATIC
  WIREFRAME
  ANIMATED
  HTML
  VIDEO
  TEMPLATE
  DOCUMENT
  OTHER
}

/// Status do card no Kanban
enum KanbanStatus {
  BACKLOG
  FILES_TO_STUDIO
  REVISAO_TEXTO
  REVIEW_DELL
  FINAL_MATERIAL
  ASSET_RELEASE
  COMPLETED
}

/// Tipo de Visual Framework
enum VFType {
  NO_VF
  MICROSOFT_JMA_CS
  OTHER
}

/// Tipo de Asset
enum AssetType {
  ESTATICO
  VIDEO
  WIREFRAME
  GIF
  STORY
  MOLDURA
  AW_STORY
  HTML
  OTHER
}

/// Frente de trabalho
enum WorkfrontFrente {
  SOCIAL
  DISPLAY
  EMAIL
  LANDING_PAGE
  PRINT
  OTHER
}

/// Ano fiscal
enum FiscalYear {
  FY25
  FY26
  FY27
  FY28
}
